<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã - –ö–∞–±–∏–Ω–µ—Ç —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .materials-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #FEFCF8, #F5F0E8);
            border-radius: 15px;
            border: 2px solid #88746b;
            position: relative;
            overflow: hidden;
        }

        .materials-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #88746b, #6B5B73);
        }

        .materials-actions {
            display: flex;
            gap: 15px;
        }

        .btn-create {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #88746b;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #88746b;
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #88746b;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #88746b;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }

        .file-input-label {
            display: block;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px dashed #88746b;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #e9ecef;
        }

        .file-name {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .upload-btn {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-materials {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            grid-column: 1 / -1;
        }

        .loading-icon {
            font-size: 3em;
            margin-bottom: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-materials {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            grid-column: 1 / -1;
        }

        .empty-materials .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <span>üéì –ö–∞–±–∏–Ω–µ—Ç —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</span>
            </div>
            <ul class="nav-menu">
                <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/cabinet">–í—ã–π—Ç–∏</a></li>
            </ul>
        </nav>

        <div class="main-container">
            <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3 style="color: #FEFCF8; margin: 0;">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                </div>
                <ul class="sidebar-menu">
                    <li class="menu-item">
                        <a href="/tutor-cabinet" style="display: block; text-decoration: none; color: inherit;">
                            üìä –û–±–∑–æ—Ä
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/timetable" style="display: block; text-decoration: none; color: inherit;">
                            üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                        </a>
                    </li>
                    <li class="menu-item active">
                        <a href="/materials" style="display: block; text-decoration: none; color: inherit;">
                            üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/students" style="display: block; text-decoration: none; color: inherit;">
                            üë• –£—á–µ–Ω–∏–∫–∏
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/reschedule" style="display: block; text-decoration: none; color: inherit;">
                            üîÑ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/income" style="display: block; text-decoration: none; color: inherit;">
                            üí∞ –î–æ—Ö–æ–¥—ã
                        </a>
                    </li>
                </ul>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="content-area">
                <div id="materials" class="page-section active">
                    <header class="header">
                        <h1>üìö –£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h1>
                        <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–±–Ω—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –û–ì–≠/–ï–ì–≠</p>
                    </header>

                    <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    <section class="materials-header">
                        <div class="materials-actions">
                            <button class="btn-create" onclick="showUploadForm()">
                                <span>‚ûï</span>
                                –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                            </button>
                        </div>
                    </section>

                    <!-- –°–µ—Ç–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
                    <section class="materials-grid" id="materialsGrid">
                        <div class="loading-materials">
                            <div class="loading-icon">‚è≥</div>
                            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...</h3>
                            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª</h3>
                <button class="close-btn" onclick="hideUploadForm()">√ó</button>
            </div>
            <form class="upload-form" id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="materialTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                    <input type="text" id="materialTitle" name="title" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
                </div>

                <div class="form-group">
                    <label for="materialDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="materialDescription" name="description" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"></textarea>
                </div>

                <div class="form-group">
                    <label for="materialCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <select id="materialCategory" name="category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option value="programming">–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                        <option value="algorithms">–ê–ª–≥–æ—Ä–∏—Ç–º—ã</option>
                        <option value="databases">–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</option>
                        <option value="theory">–¢–µ–æ—Ä–∏—è</option>
                        <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                        <option value="homework">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="examType">–î–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ *</label>
                    <select id="examType" name="exam_type" required>
                        <option value="both">–û–ì–≠ –∏ –ï–ì–≠</option>
                        <option value="oge">–¢–æ–ª—å–∫–æ –û–ì–≠</option>
                        <option value="ege">–¢–æ–ª—å–∫–æ –ï–ì–≠</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–§–∞–π–ª –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="materialFile" name="file" required accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip,.rar">
                        <label for="materialFile" class="file-input-label">
                            üìé –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (PDF, DOC, PPT, ZIP)
                        </label>
                    </div>
                    <div class="file-name" id="fileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                </div>

                <button type="submit" class="upload-btn" id="uploadBtn">
                    üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                </button>
            </form>
        </div>
    </div>

    <script>
        let allMaterials = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadMaterials();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
            document.getElementById('materialFile').addEventListener('change', function(e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                document.getElementById('fileName').textContent = fileName;
            });
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏
        function showUploadForm() {
            document.getElementById('uploadModal').style.display = 'flex';
            document.getElementById('uploadForm').reset();
            document.getElementById('fileName').textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
        }

        // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏
        function hideUploadForm() {
            document.getElementById('uploadModal').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadMaterials() {
            const materialsGrid = document.getElementById('materialsGrid');

            try {
                const response = await fetch('/api/materials');
                const data = await response.json();

                if (data.success) {
                    allMaterials = data.materials;
                    renderMaterials(allMaterials);
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                showTestMaterials();
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        function renderMaterials(materials) {
            const materialsGrid = document.getElementById('materialsGrid');

            if (!materials || materials.length === 0) {
                materialsGrid.innerHTML = `
                    <div class="empty-materials">
                        <div class="icon">üìö</div>
                        <h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</h3>
                        <p>–í—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ —É—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.</p>
                        <button class="btn-create" onclick="showUploadForm()" style="margin-top: 15px;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
                        </button>
                    </div>
                `;
                return;
            }

            let materialsHTML = '';

            materials.forEach(material => {
                materialsHTML += `
                    <div class="material-card">
                        <div class="material-header">
                            <h4>${material.title}</h4>
                            <span class="material-type">${getFileTypeText(material.file_type)}</span>
                        </div>
                        <div class="material-info">
                            <p>üìÑ ${material.file_type.toUpperCase()} –¥–æ–∫—É–º–µ–Ω—Ç</p>
                            <p>üìè –†–∞–∑–º–µ—Ä: ${material.file_size}</p>
                            <p>üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${formatDate(material.created_at)}</p>
                            <p>üéØ ${getExamTypeText(material.exam_type)}</p>
                        </div>
                        <div class="material-actions">
                            <button class="action-btn small" onclick="downloadMaterial(${material.id}, '${material.file_path}', '${material.title}.${material.file_type}')">
                                üì• –°–∫–∞—á–∞—Ç—å
                            </button>
                            <button class="action-btn small" onclick="previewMaterial(${material.id}, '${material.file_path}', '${material.file_type}')">
                                üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                            </button>
                            <button class="action-btn small decline" onclick="deleteMaterial(${material.id}, '${material.title}')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            });

            materialsGrid.innerHTML = materialsHTML;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const uploadBtn = document.getElementById('uploadBtn');

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';

                const response = await fetch('/api/tutor/upload-material', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                    hideUploadForm();
                    loadMaterials(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª';
            }
        });

        // –°–ö–ê–ß–ê–¢–¨ –º–∞—Ç–µ—Ä–∏–∞–ª
        async function downloadMaterial(materialId, filePath, fileName) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚è≥ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ...';
                button.disabled = true;

                if (filePath && filePath !== 'None') {
                    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    const response = await fetch(`/api/materials/${materialId}/download`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
                        await fetch(`/api/materials/${materialId}/download-stats`, {
                            method: 'POST'
                        });

                        alert('‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } else {
                        throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                } else {
                    // –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
                    if (confirm('–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –æ–Ω–ª–∞–π–Ω?')) {
                        previewMaterial(materialId, filePath, getFileTypeFromName(fileName));
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞');
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const button = event.target;
                button.innerHTML = 'üì• –°–∫–∞—á–∞—Ç—å';
                button.disabled = false;
            }
        }

        // –ü–†–û–°–ú–û–¢–†–ï–¢–¨ –º–∞—Ç–µ—Ä–∏–∞–ª
        function previewMaterial(materialId, filePath, fileType) {
            try {
                if (filePath && filePath !== 'None') {
                    // –î–ª—è PDF —Ñ–∞–π–ª–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                    if (fileType === 'pdf') {
                        window.open(`/api/materials/${materialId}/preview`, '_blank');
                    }
                    // –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ Word –∏—Å–ø–æ–ª—å–∑—É–µ–º Google Docs viewer
                    else if (['doc', 'docx'].includes(fileType)) {
                        window.open(`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(window.location.origin + '/api/materials/' + materialId + '/preview')}`, '_blank');
                    }
                    // –î–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π
                    else if (['ppt', 'pptx'].includes(fileType)) {
                        window.open(`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(window.location.origin + '/api/materials/' + materialId + '/preview')}`, '_blank');
                    }
                    // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
                    else if (fileType === 'txt') {
                        window.open(`/api/materials/${materialId}/preview`, '_blank');
                    }
                    // –î–ª—è –∞—Ä—Ö–∏–≤–æ–≤ - —Å–∫–∞—á–∏–≤–∞–µ–º
                    else if (['zip', 'rar'].includes(fileType)) {
                        if (confirm('–≠—Ç–æ –∞—Ä—Ö–∏–≤–Ω—ã–π —Ñ–∞–π–ª. –•–æ—Ç–∏—Ç–µ —Å–∫–∞—á–∞—Ç—å –µ–≥–æ?')) {
                            downloadMaterial(materialId, filePath, `material_${materialId}.${fileType}`);
                        }
                    }
                    else {
                        alert('–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –§–∞–π–ª –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω.');
                        downloadMaterial(materialId, filePath, `material_${materialId}.${fileType}`);
                    }
                } else {
                    alert('–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞');
            }
        }

        // –£–î–ê–õ–ò–¢–¨ –º–∞—Ç–µ—Ä–∏–∞–ª
        async function deleteMaterial(materialId, materialTitle) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª "${materialTitle}"?`)) {
                return;
            }

            try {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';
                button.disabled = true;

                const response = await fetch(`/api/tutor/materials/${materialId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                    loadMaterials(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
            } finally {
                const button = event.target;
                button.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
                button.disabled = false;
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getFileTypeText(fileType) {
            const typeMap = {
                'pdf': 'PDF',
                'ppt': 'PPT',
                'pptx': 'PPTX',
                'doc': 'DOC',
                'docx': 'DOCX',
                'txt': 'TXT',
                'zip': 'ZIP',
                'rar': 'RAR'
            };
            return typeMap[fileType] || fileType.toUpperCase();
        }

        function getFileTypeFromName(fileName) {
            return fileName.split('.').pop().toLowerCase();
        }

        function getExamTypeText(examType) {
            const typeMap = {
                'oge': '–î–ª—è –û–ì–≠',
                'ege': '–î–ª—è –ï–ì–≠',
                'both': '–î–ª—è –û–ì–≠ –∏ –ï–ì–≠'
            };
            return typeMap[examType] || examType;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }

        function showError(message) {
            const materialsGrid = document.getElementById('materialsGrid');
            materialsGrid.innerHTML = `
                <div class="empty-materials">
                    <div class="icon">‚ùå</div>
                    <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                    <p>${message}</p>
                    <button class="btn-create" onclick="loadMaterials()" style="margin-top: 15px;">
                        üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        function showTestMaterials() {
            const testMaterials = [
                {
                    id: 1,
                    title: '–û—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ PascalABC',
                    file_type: 'pdf',
                    file_size: '3.2 MB',
                    exam_type: 'oge',
                    file_path: '/uploads/materials/sample.pdf',
                    created_at: '2024-05-20'
                },
                {
                    id: 2,
                    title: '–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –±–ª–æ–∫-—Å—Ö–µ–º—ã',
                    file_type: 'pptx',
                    file_size: '4.1 MB',
                    exam_type: 'both',
                    file_path: '/uploads/materials/sample.pptx',
                    created_at: '2024-05-18'
                }
            ];
            renderMaterials(testMaterials);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('uploadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideUploadForm();
            }
        });
    </script>
</body>
</html>