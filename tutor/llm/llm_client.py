import os
import requests
from requests.exceptions import ConnectionError, Timeout, RequestException


LMSTUDIO_URL = "http://127.0.0.1:12345/v1/chat/completions"
LMSTUDIO_BASE_URL = "http://127.0.0.1:12345"
LMSTUDIO_MODEL = "google/gemma-3-4b"


def get_available_models():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏–∑ LM Studio"""
    try:
        response = requests.get(f"{LMSTUDIO_BASE_URL}/v1/models", timeout=5)
        if response.status_code == 200:
            data = response.json()
            models = data.get("data", [])
            return [model.get("id") for model in models]
        return []
    except Exception:
        return []


def generate_test_from_text(text, material_name="z5", max_retries=2):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é LM Studio
    
    –°–æ–∑–¥–∞–µ—Ç 5 —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –≥–¥–µ –µ—Å—Ç—å 4 –æ—Ç–≤–µ—Ç–∞, 1 –≤–µ—Ä–Ω—ã–π.
    
    Args:
        text: –¢–µ–∫—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞
        material_name: –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "z5")
        max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ 503
    
    Returns:
        str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    """
    import time
    
    prompt = f"""–°–æ–∑–¥–∞–π 5 —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–º–∞—Ç–µ—Ä–∏–∞–ª: —Ñ–∞–π–ª {material_name}).

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ—Å—Ç–∞–º:
- –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤–æ–ø—Ä–æ—Å
- –£ –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (A, B, C, D)
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–π —Ç–µ—Å—Ç—ã –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞

–ú–∞—Ç–µ—Ä–∏–∞–ª:
{text}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1. [–í–æ–ø—Ä–æ—Å]
   A) [–í–∞—Ä–∏–∞–Ω—Ç 1]
   B) [–í–∞—Ä–∏–∞–Ω—Ç 2]
   C) [–í–∞—Ä–∏–∞–Ω—Ç 3]
   D) [–í–∞—Ä–∏–∞–Ω—Ç 4]
   –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: [–±—É–∫–≤–∞]

2. [–í–æ–ø—Ä–æ—Å]
   ...
"""
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
    available_models = get_available_models()
    model_to_use = LMSTUDIO_MODEL
    
    # –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ, –Ω–æ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
    if available_models and LMSTUDIO_MODEL not in available_models:
        if available_models:
            model_to_use = available_models[0]
            print(f"‚ö†Ô∏è –ú–æ–¥–µ–ª—å '{LMSTUDIO_MODEL}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º '{model_to_use}'")
    
    payload = {
        "model": model_to_use,
        "messages": [
            {"role": "system", "content": "You are a helpful test generator. You create educational tests with multiple choice questions."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.7,
        "max_tokens": 2000
    }
    
    # –ü—ã—Ç–∞–µ–º—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    for attempt in range(max_retries + 1):
        try:
            if attempt > 0:
                wait_time = 5 * attempt  # 5, 10 —Å–µ–∫—É–Ω–¥
                print(f"‚è≥ –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries + 1}. –û–∂–∏–¥–∞–Ω–∏–µ {wait_time} —Å–µ–∫—É–Ω–¥...")
                time.sleep(wait_time)
            
            print(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LM Studio: {LMSTUDIO_URL}")
            print(f"üì¶ –ú–æ–¥–µ–ª—å: {model_to_use}")
            
            response = requests.post(LMSTUDIO_URL, json=payload, timeout=120)
            
            print(f"üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: —Å—Ç–∞—Ç—É—Å {response.status_code}")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö HTTP –æ—à–∏–±–æ–∫
            if response.status_code == 503:
                # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
                error_text = response.text if response.text else "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç"
                response_headers = dict(response.headers)
                
                print(f"‚ùå –û—à–∏–±–∫–∞ 503")
                print(f"   –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞: {response_headers}")
                print(f"   –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: {error_text[:500] if error_text else '–ü–£–°–¢–û'}")
                print(f"   –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(error_text) if error_text else 0} –±–∞–π—Ç")
                
                # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
                try:
                    if error_text:
                        error_data = response.json()
                        print(f"üìã JSON –æ—Ç–≤–µ—Ç: {error_data}")
                except Exception as json_error:
                    print(f"   –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: {json_error}")
                
                # –ï—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ –ø–æ–ø—ã—Ç–∫–∏ - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                if attempt < max_retries:
                    print(f"‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω 503, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ {5 * (attempt + 1)} —Å–µ–∫—É–Ω–¥...")
                    continue
                
                # –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
                return (
                    "‚ùå –û—à–∏–±–∫–∞: LM Studio —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (503).\n\n"
                    "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                    "1. –ú–æ–¥–µ–ª—å –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è - –ø–æ–¥–æ–∂–¥–∏—Ç–µ 10-30 —Å–µ–∫—É–Ω–¥\n"
                    "2. –ú–æ–¥–µ–ª—å –Ω–µ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é\n"
                    "3. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω\n"
                    "4. –ú–æ–¥–µ–ª—å –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –∑–∞–ø—Ä–æ—Å–æ–º\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                    "1. –ü–æ–¥–æ–∂–¥–∞—Ç—å 10-30 —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞\n"
                    "2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å LM Studio\n"
                    "3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–æ–¥–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (—Å—Ç–∞—Ç—É—Å READY)\n"
                    "4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –º–æ–¥–µ–ª—å\n\n"
                    f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {error_text[:300]}"
                )
            elif response.status_code == 404:
                return (
                    "‚ùå –û—à–∏–±–∫–∞: –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (404).\n\n"
                    f"–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å: '{model_to_use}'\n"
                    f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: {', '.join(available_models) if available_models else '–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å'}\n\n"
                    "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ LM Studio."
                )
            elif response.status_code == 500:
                error_text = response.text[:500] if response.text else "–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π"
                return (
                    "‚ùå –û—à–∏–±–∫–∞: –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ LM Studio (500).\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                    "1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å LM Studio\n"
                    "2. –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å\n"
                    "3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ LM Studio\n\n"
                    f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {error_text}"
                )
            
            # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω—ã–π - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            response.raise_for_status()
            data = response.json()
            
            print(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LM Studio")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–≤–µ—Ç–∞
            choices = data.get("choices", [])
            if not choices:
                return "‚ùå –û—à–∏–±–∫–∞: LM Studio –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
            
            content = choices[0].get("message", {}).get("content", "").strip()
            if not content:
                return "‚ùå –û—à–∏–±–∫–∞: –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
            
            return content
            
        except ConnectionError as e:
            if attempt < max_retries:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                continue
            return (
                "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ LM Studio.\n\n"
                "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n"
                "1. LM Studio –∑–∞–ø—É—â–µ–Ω\n"
                "2. API —Å–µ—Ä–≤–µ—Ä –≤–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (Status: Running)\n"
                "3. –ü–æ—Ä—Ç 12345 –Ω–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º\n"
                "4. –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: http://127.0.0.1:12345\n\n"
                f"–î–µ—Ç–∞–ª–∏: {str(e)}"
            )
        except Timeout:
            if attempt < max_retries:
                print(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                continue
            return (
                "‚ùå –û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç LM Studio (120 —Å–µ–∫—É–Ω–¥).\n\n"
                "–ú–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                "1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å\n"
                "2. –£–º–µ–Ω—å—à–∏—Ç—å –æ–±—ä–µ–º –≤—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞\n"
                "3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã\n"
                "4. –£–≤–µ–ª–∏—á–∏—Ç—å GPU Offload –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö LM Studio"
            )
        except RequestException as e:
            if attempt < max_retries:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                continue
            return (
                f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LM Studio: {str(e)}\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
                "1. LM Studio –∑–∞–ø—É—â–µ–Ω –∏ —Å–µ—Ä–≤–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω\n"
                "2. –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
            )
        except Exception as e:
            if attempt < max_retries:
                print(f"‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                continue
            return f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å LM Studio."
    
    # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã –∏ –º—ã –¥–æ—à–ª–∏ —Å—é–¥–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É
    return (
        "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫.\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
        "1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å LM Studio\n"
        "2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–æ–¥–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞\n"
        "3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ LM Studio –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"
    )

